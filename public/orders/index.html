<html>
<head>
<title>Orders feed</title>

<link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
<style>
body {
  font-family: 'Roboto';font-size: 22px;
}

table {
  table-layout: fixed;
}

tr.PARTIAL_FILLED td:nth-child(4){
  border: 1px solid black;
}

tr.FILLED {
  opacity: 0.4
}

tr.FILLED {
  opacity: 0.4
}

tr.CANCELLED {
  text-decoration: line-through;
  text-decoration-style: wavy;
}

tr.BUY{
  color: Blue;
}
tr.SELL{
  color: Fuchsia;
}

tr.pairName td {
  font-weight: bold;
}

td {
  vertical-align: text-top;
  padding: 0.3em;
}

td.bids {
  border: 1px solid blue;
  color: blue;
}

td.asks{
  border: 1px solid red;
  color: red;
}

</style>

<script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"
        charset="utf-8"
        type="text/javascript">
</script>

<script src="/utils.js"></script>

<script>

function onload() {
  let pairreq = new XMLHttpRequest()

  pairreq.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      let tbl = document.getElementById("feed")

      let data = JSON.parse(this.responseText)

      let ws = new WebSocket("ws://52.78.227.253:8081/socket")

      ws.onmessage = ev => {
        let data = JSON.parse(ev.data)
        if(data.channel && data.channel == "raw_orderbook" && data.event){
          let pair, orders
          if (data.event.type==="INIT"){
            pair = data.event.payload && data.event.payload.pairName
            data = data.event.payload && data.event.payload.orders
          } else if(data.event.payload) {
            data = data.event.payload
            pair = data[0].pairName
          }

          if (data!=null){
            data.forEach(function(ord){
              for( let i=tbl.rows.length;i--;)
                if(ord.hash==tbl.rows[i].id)
                  tbl.deleteRow(i)

              ord.amount = reverseAmount(ord.amount) -  reverseAmount(ord.filledAmount)
              ord.price = reversePrice(ord.pricepoint)

              let row = tbl.insertRow(0)
              row.id = ord.hash
              row.className = ord.status+" "+ord.side
              row.insertCell().innerHTML = ['side','pairName'].map(ele=>ord[ele]).join(" ")
              row.insertCell().innerHTML = ord.amount
              row.insertCell().innerHTML = ord.price
              row.insertCell().innerHTML = ord.status
              row.insertCell().innerHTML = ord.createdAt
            })
          }
        }
      }
 
      data.filter( ele => ele.quoteTokenSymbol==="WETH" )
        .forEach( ele => {
          let pairName = ele.baseTokenSymbol+"/"+ele.quoteTokenSymbol

          ws.addEventListener("open", _ => {
            ws.send(JSON.stringify({
              "channel": "raw_orderbook",
              "event": {
                "type": "SUBSCRIBE",
                "payload": {
                  "baseToken": ele.baseTokenAddress,
                  "quoteToken": ele.quoteTokenAddress,
                }
              }
            }))
          })
       })
    }
  }

  pairreq.open("GET", "/api/pairs")
  pairreq.send()
}

</script>

</head>

<body onload=onload()>

<table>
<thead>
<tr>
<th>pair</th>
<th>amount</th>
<th>price</th>
<th>status</th>
<th>createdAt</th>
</tr>
</thead>
<tbody id=feed>
</tbody>
</table>
</body>
</html>
